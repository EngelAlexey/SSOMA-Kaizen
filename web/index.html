<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Kaizen GPT</title>
  <link rel="shortcut icon" href="./assets/Icon App.png" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <!-- Markdown Parser -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <style>
    :root{
      --bg:#0b0b0b;
      --panel:#111214;
      --panel-2:#17181b;
      --text:#ffffff;
      --muted:#9aa1a9;
      --primary:#e10600;
      --primary-700:#b00500;
      --ok:#14b885;
      --border:#23252a;
      --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
      color:var(--text); background:var(--bg);
      /* Imagen de fondo opcional si existe, sino usa color base */
      background-image:url('./assets/Kaizen Crimson 1.003000.png');
      background-size:cover; background-position:center; background-attachment:fixed;
    }
    .veil{position:fixed; inset:0; background:linear-gradient(180deg,rgba(0,0,0,.65),rgba(0,0,0,.75)); pointer-events:none; z-index:-1;}

    .layout{display:grid; grid-template-columns:280px 1fr; gap:18px; max-width:1280px; margin:0 auto; padding:24px 18px 0; position:relative; height:100vh;}
    @media (max-width:980px){ .layout{grid-template-columns:1fr} .sidebar{display:none} }

    /* Sidebar (historial) */
    .sidebar{
      background:linear-gradient(180deg,#0d0e10,#0a0b0c);
      border:1px solid var(--border); border-radius:16px; padding:12px; box-shadow:var(--shadow);
      height:calc(100vh - 48px); overflow-y:auto; display:flex; flex-direction:column;
    }
    .sb-head{display:flex; align-items:center; gap:10px; margin:6px 4px 20px; padding-bottom:10px; border-bottom:1px solid var(--border);}
    .sb-head img{width:32px; height:32px; object-fit:contain}
    .sb-title{font-weight:600; font-size:16px;}
    .sb-btn-new{
        margin-top:auto; background:var(--primary); color:white; border:none; padding:10px; 
        border-radius:8px; cursor:pointer; font-weight:600; width:100%; text-align:center;
        transition: background .2s;
    }
    .sb-btn-new:hover{background:var(--primary-700);}
    
    .conv{border:1px solid transparent; border-radius:8px; padding:10px; margin:4px 0; background:transparent; cursor:pointer; transition:all .2s;}
    .conv:hover{background:rgba(255,255,255,0.05);}
    .conv .t{font-size:13px; color:#e6e8ea; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .conv .s{font-size:11px; color:var(--muted); margin-top:2px}
    .conv.active{background:#1b1d21; border-color:var(--border); border-left:3px solid var(--primary);}

    /* Main */
    main { display:flex; flex-direction:column; height:calc(100vh - 48px); }

    .brand{
      display:flex; align-items:center; gap:14px; user-select:none; width:fit-content;
      padding:8px 14px; border-radius:14px; background:rgba(0,0,0,.35); backdrop-filter: blur(4px);
      border:1px solid rgba(255,255,255,.06); margin-bottom:10px;
    }
    .brand img.logo{height:32px; width:32px; object-fit:contain; filter: drop-shadow(0 0 2px rgba(0,0,0,.5));}
    .brand h1{margin:0; font-size:16px; letter-spacing:.5px}
    .brand .sub{font-size:11px; color:var(--muted); margin-top:0px}
    .brand .dot{color:var(--ok); font-size:10px; margin-left:6px}

    .panel{
      flex:1; display:flex; flex-direction:column;
      background:linear-gradient(180deg,var(--panel),var(--panel-2));
      border:1px solid var(--border);
      border-radius:16px; overflow:hidden; box-shadow:var(--shadow);
      position:relative;
    }
    
    .messages{
        flex:1; overflow-y:auto; padding:20px; scroll-behavior:smooth;
        display:flex; flex-direction:column;
    }
    
    .msg{display:flex; gap:12px; margin-bottom:18px; animation:pop .2s ease-out; max-width:100%;}
    .msg.user{flex-direction:row-reverse;}
    
    @keyframes pop{from{transform:scale(.98); opacity:.0} to{transform:scale(1); opacity:1}}
    
    .avatar{
      flex:0 0 36px; height:36px; border-radius:10px; background:#0e0f12; display:grid; place-items:center;
      border:1px solid var(--border);
    }
    .avatar.user{background:#0d1411; border-color:#123529}
    .avatar.ai{background:#150e0e; border-color:#2a1414}
    .avatar img{width:24px; height:24px; object-fit:contain}
    
    .bubble{
      max-width:85%; padding:10px 14px; border-radius:12px;
      line-height:1.6; border:1px solid var(--border);
      background:#0f1512; font-size:14px;
      word-wrap: break-word;
    }
    .user .bubble { background: #1c1e22; border-color:#333; color:#fff; }
    .ai .bubble { background: #111; border-color:var(--border); }
    
    .meta{font-size:11px; color:var(--muted); margin-top:4px; text-align:right;}
    .ai .meta{text-align:left;}

    /* Markdown Content Styles */
    .markdown-body p { margin-bottom: 0.5em; }
    .markdown-body ul { list-style-type: disc; margin-left: 1.2em; margin-bottom: 0.5em; }
    .markdown-body ol { list-style-type: decimal; margin-left: 1.2em; margin-bottom: 0.5em; }
    .markdown-body strong { color: var(--primary); font-weight: 700; }
    .markdown-body h1, .markdown-body h2, .markdown-body h3 { color: #fff; margin-top: 0.8em; font-weight: bold; font-size:1.1em; border-bottom:1px solid #333; padding-bottom:4px;}
    .markdown-body code { background: #222; padding: 2px 4px; border-radius: 3px; font-family: monospace; color:#ffbd2e; }
    .markdown-body pre { background: #000; padding: 10px; border-radius: 6px; overflow-x: auto; margin: 0.5em 0; border:1px solid #333; }
    .markdown-body pre code { background: transparent; color: #eee; }

    /* chips de archivo */
    .file-chip{display:inline-flex; align-items:center; gap:8px; margin-bottom:6px; padding:6px 10px; border-radius:8px;
      border:1px solid #2a2d32; background:#1a1c20; font-size:12px; color:#cfd6de;}
    .file-chip i {color: var(--primary);}

    /* composer */
    .composer{
        padding:14px; background:rgba(17,18,20,0.95); 
        border-top:1px solid var(--border); 
        backdrop-filter: blur(10px);
    }
    .bar{
        display:flex; gap:10px; align-items:center; 
        background:#090a0b; border:1px solid var(--border); border-radius:12px; padding:6px;
        box-shadow:inset 0 2px 4px rgba(0,0,0,0.5);
    }
    .bar input[type="file"]{display:none}
    
    .btn{
        height:38px; min-width:38px; border:0; border-radius:8px; 
        background:#1a1c20; color:#fff; cursor:pointer; display:grid; place-items:center; 
        transition:.2s; border:1px solid transparent;
    }
    .btn:hover{background:#25282e; border-color:#444;}
    .btn.primary{background:var(--primary); color:white;}
    .btn.primary:hover{background:var(--primary-700);}
    .btn:disabled{opacity:0.5; cursor:not-allowed;}

    .field{flex:1; display:flex; align-items:center; padding:0 8px;}
    .field input{
        width:100%; height:38px; background:transparent; border:0; 
        outline:none; color:#fff; font-size:14px; font-family:inherit;
    }
    
    .hint{font-size:11px; color:#555; text-align:center; margin-top:6px;}

    /* typing dots */
    .typing{display:inline-flex; gap:4px; align-items:center; padding:4px 0;}
    .dot{width:6px; height:6px; border-radius:50%; background:var(--muted); animation:bounce 1s infinite ease-in-out;}
    .dot:nth-child(2){animation-delay:.15s}
    .dot:nth-child(3){animation-delay:.3s}
    @keyframes bounce{0%,80%,100%{transform:translateY(0); opacity:.5} 40%{transform:translateY(-4px); opacity:1}}

    /* Preview flotante del adjunto */
    .attach-float{
      position:absolute; left:14px; bottom:80px; right:14px;
      background:#1a1c20; border:1px solid var(--border); border-radius:12px;
      padding:10px; display:none; align-items:center; gap:10px;
      animation: slideUp 0.2s ease; z-index:10;
    }
    @keyframes slideUp { from{transform:translateY(10px); opacity:0} to{transform:translateY(0); opacity:1} }
    
    .attach-icon{width:32px; height:32px; background:#2a2c30; border-radius:6px; display:grid; place-items:center; font-size:14px;}
    .attach-info{flex:1; overflow:hidden;}
    .attach-name{font-size:12px; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .attach-size{font-size:10px; color:var(--muted);}
    .attach-close{background:none; border:none; color:var(--muted); cursor:pointer; font-size:14px;}
    .attach-close:hover{color:var(--primary);}

    /* Scrollbar dentro de sidebar y mensajes */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
  </style>
</head>
<body>
  <div class="veil"></div>

  <div class="layout">
    <!-- Sidebar: historial -->
    <aside class="sidebar" id="sidebar">
      <div class="sb-head">
        <img src="./assets/Kaizen B.png" alt="k">
        <div>
          <div class="sb-title">Historial</div>
        </div>
      </div>
      
      <div id="convList" style="flex:1; overflow-y:auto; margin-bottom:10px;"></div>
      
      <button class="sb-btn-new" onclick="createNewChat()">+ Nuevo Chat</button>
    </aside>

    <main>
      <!-- Header -->
      <div class="brand">
        <img class="logo" src="./assets/Icon App.png" alt="Kaizen">
        <div>
          <h1>Kaizen <span class="dot">‚óè</span></h1>
          <div class="sub">Resource Management ¬∑ Seguridad & RRHH</div>
        </div>
      </div>

      <!-- Panel -->
      <div class="panel">
        <div id="messages" class="messages">
            <!-- Mensajes se inyectan aqu√≠ -->
            <div style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; opacity:0.3;">
                <img src="./assets/Icon App.png" style="width:64px; margin-bottom:10px; filter:grayscale(1);">
                <div>Selecciona un chat o inicia uno nuevo</div>
            </div>
        </div>

        <!-- Preview Flotante -->
        <div class="attach-float" id="attachFloat">
            <div class="attach-icon">üìé</div>
            <div class="attach-info">
                <div class="attach-name" id="afName">archivo.pdf</div>
                <div class="attach-size" id="afSize">120 KB</div>
            </div>
            <button class="attach-close" id="afClose">‚úï</button>
        </div>

        <div class="composer">
          <div class="bar">
            <label class="btn" title="Adjuntar archivo">
              <input id="file" type="file" multiple />
              <span style="font-size:18px; color:var(--muted)">üìé</span>
            </label>
            <div class="field">
              <input id="input" placeholder="Escribe tu mensaje..." autocomplete="off" />
            </div>
            <button id="send" class="btn primary" title="Enviar">‚û§</button>
          </div>
          <div class="hint">
            IA puede cometer errores. Revisa la informaci√≥n importante.
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
  // CONFIGURACI√ìN
  const API_URL = 'http://localhost:3000/chat/query'; // Aseg√∫rate que coincide con tu API
  
  // ESTADO
  let chats = JSON.parse(localStorage.getItem('kaizen_chats')) || [];
  let currentChatId = null;
  let selectedFiles = [];

  // ELEMENTOS DOM
  const dom = {
      input: document.getElementById('input'),
      sendBtn: document.getElementById('send'),
      messages: document.getElementById('messages'),
      convList: document.getElementById('convList'),
      fileInput: document.getElementById('file'),
      attachFloat: document.getElementById('attachFloat'),
      afName: document.getElementById('afName'),
      afSize: document.getElementById('afSize'),
      afClose: document.getElementById('afClose')
  };

  // INICIO
  document.addEventListener('DOMContentLoaded', () => {
      if (chats.length > 0) {
          loadChat(chats[0].id);
      } else {
          createNewChat();
      }
      renderSidebar();
  });

  // --- L√ìGICA DE CHATS ---

  function createNewChat() {
      const newId = Date.now().toString();
      const newChat = {
          id: newId,
          title: 'Nueva consulta',
          messages: [],
          timestamp: Date.now()
      };
      chats.unshift(newChat);
      saveChats();
      loadChat(newId);
  }

  function loadChat(id) {
      currentChatId = id;
      const chat = chats.find(c => c.id === id);
      if (!chat) return;

      // Limpiar UI
      dom.messages.innerHTML = '';
      
      // Cargar mensajes hist√≥ricos
      chat.messages.forEach(msg => {
          appendMessageToUI(msg.role, msg.content, msg.files);
      });

      // Mensaje de bienvenida si est√° vac√≠o
      if (chat.messages.length === 0) {
          appendMessageToUI('ai', 'Hola. Soy **SSOMA-Kaizen**. Puedo analizar documentos, fotos de obra o responder dudas del manual.');
      }

      renderSidebar();
      scrollToBottom();
  }

  function saveChats() {
      localStorage.setItem('kaizen_chats', JSON.stringify(chats));
      renderSidebar();
  }

  function renderSidebar() {
      dom.convList.innerHTML = '';
      chats.forEach(chat => {
          const div = document.createElement('div');
          div.className = `conv ${chat.id === currentChatId ? 'active' : ''}`;
          
          // Fecha formateada
          const date = new Date(chat.timestamp).toLocaleDateString();
          
          div.innerHTML = `
              <div class="t">${chat.title}</div>
              <div class="s">${date}</div>
          `;
          
          // Evento Clic
          div.onclick = (e) => {
              // Peque√±a l√≥gica para borrado con clic derecho (opcional) o bot√≥n
              loadChat(chat.id);
          };
          
          // Bot√≥n borrar (peque√±o truco en hover o separado)
          // Para mantener dise√±o simple, podr√≠as a√±adir un icono X
          
          dom.convList.appendChild(div);
      });
  }

  // --- L√ìGICA DE MENSAJES ---

  async function sendMessage() {
      const text = dom.input.value.trim();
      const files = selectedFiles;

      if (!text && files.length === 0) return;

      // 1. UI Usuario
      appendMessageToUI('user', text, files);
      
      // Guardar en historial
      const fileNames = files.map(f => f.name);
      saveMessageToHistory('user', text, fileNames);

      // Limpiar Input
      dom.input.value = '';
      clearFiles();

      // Indicador de carga
      const loadingId = showTyping();
      dom.sendBtn.disabled = true;

      try {
          // 2. Preparar FormData
          const formData = new FormData();
          formData.append('text', text);
          files.forEach(f => formData.append('files', f));
          
          // 3. Petici√≥n a API
          const res = await fetch(API_URL, {
              method: 'POST',
              body: formData
          });

          const data = await res.json();

          removeTyping(loadingId);

          if (data.success) {
              appendMessageToUI('ai', data.reply);
              saveMessageToHistory('ai', data.reply);
              
              // Actualizar t√≠tulo si es el primer mensaje
              const currentChat = chats.find(c => c.id === currentChatId);
              if (currentChat.messages.length <= 2 && text) {
                  currentChat.title = text.substring(0, 25) + '...';
                  saveChats();
              }
          } else {
              appendMessageToUI('ai', `‚ùå **Error:** ${data.message || 'Error desconocido'}`);
          }

      } catch (error) {
          removeTyping(loadingId);
          appendMessageToUI('ai', `‚ùå **Error de conexi√≥n:** Aseg√∫rate que el servidor (API) est√© corriendo en el puerto 3000.`);
          console.error(error);
      } finally {
          dom.sendBtn.disabled = false;
          dom.input.focus();
      }
  }

  function appendMessageToUI(role, text, files = []) {
      const div = document.createElement('div');
      div.className = `msg ${role}`;

      const avatarSrc = role === 'ai' ? './assets/Kaizen B.png' : './assets/Icon App.png';
      const label = role === 'ai' ? 'SSOMA-Kaizen' : 'T√∫';

      let filesHtml = '';
      if (files && files.length > 0) {
          files.forEach(f => {
              const fname = typeof f === 'string' ? f : f.name;
              filesHtml += `
                  <div class="file-chip">
                      <span>üìé ${fname}</span>
                  </div>
              `;
          });
      }

      // Renderizar Markdown
      const contentHtml = role === 'ai' ? marked.parse(text) : text.replace(/\n/g, '<br>');

      div.innerHTML = `
          <div class="avatar ${role}"><img src="${avatarSrc}"></div>
          <div style="width:100%">
              ${filesHtml}
              <div class="bubble markdown-body">${contentHtml}</div>
              <div class="meta">${label}</div>
          </div>
      `;

      dom.messages.appendChild(div);
      scrollToBottom();
  }

  function saveMessageToHistory(role, content, files) {
      const chat = chats.find(c => c.id === currentChatId);
      if (chat) {
          chat.messages.push({ role, content, files, timestamp: Date.now() });
          saveChats();
      }
  }

  // --- UTILIDADES DE ARCHIVO ---

  dom.fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
          selectedFiles = Array.from(e.target.files);
          renderFilePreview();
      }
  });

  function renderFilePreview() {
      if (selectedFiles.length > 0) {
          dom.attachFloat.style.display = 'flex';
          dom.afName.textContent = `${selectedFiles.length} archivo(s)`;
          dom.afSize.textContent = selectedFiles.map(f => f.name).join(', ');
      } else {
          dom.attachFloat.style.display = 'none';
      }
  }

  function clearFiles() {
      selectedFiles = [];
      dom.fileInput.value = '';
      renderFilePreview();
  }

  dom.afClose.addEventListener('click', clearFiles);

  // --- UI HELPERS ---

  function showTyping() {
      const id = 'typing-' + Date.now();
      const div = document.createElement('div');
      div.id = id;
      div.className = 'msg ai';
      div.innerHTML = `
          <div class="avatar ai"><img src="./assets/Kaizen B.png"></div>
          <div>
              <div class="bubble" style="padding:12px 18px">
                  <div class="typing"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
              </div>
          </div>
      `;
      dom.messages.appendChild(div);
      scrollToBottom();
      return id;
  }

  function removeTyping(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
  }

  function scrollToBottom() {
      dom.messages.scrollTop = dom.messages.scrollHeight;
  }

  // Eventos de teclado
  dom.input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
      }
  });

  dom.sendBtn.addEventListener('click', sendMessage);

</script>
</body>
</html>