<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSOMA - Kaizen AI</title>
    
    <!-- Estilos y Fuentes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Configuración de Tema Kaizen -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        kaizen: {
                            red: '#D32F2F',
                            dark: '#121212',
                            surface: '#1E1E1E',
                            light: '#E0E0E0',
                            accent: '#FF5252'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1E1E1E; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #D32F2F; }

        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #ccc;
            border-radius: 50%;
            animation: typing 1.4s infinite both;
            margin: 0 2px;
        }
        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.5); opacity: 1; }
        }

        /* Markdown Styles */
        .markdown-body p { margin-bottom: 0.8em; }
        .markdown-body ul { list-style-type: disc; margin-left: 1.5em; margin-bottom: 0.8em; }
        .markdown-body ol { list-style-type: decimal; margin-left: 1.5em; margin-bottom: 0.8em; }
        .markdown-body strong { color: #FF5252; font-weight: 700; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { color: #fff; margin-top: 1em; font-weight: bold; }
        .markdown-body code { background: #333; padding: 2px 4px; border-radius: 3px; font-family: monospace; }
        .markdown-body pre { background: #252525; padding: 10px; border-radius: 5px; overflow-x: auto; margin-bottom: 1em; }
    </style>
</head>
<body class="bg-kaizen-dark text-kaizen-light h-screen flex overflow-hidden font-sans">

    <!-- SIDEBAR (Historial de Chats) -->
    <aside id="sidebar" class="w-64 bg-kaizen-surface flex flex-col border-r border-gray-800 transition-all duration-300 absolute md:relative z-20 h-full -translate-x-full md:translate-x-0">
        
        <!-- Logo y Nuevo Chat -->
        <div class="p-4 border-b border-gray-700">
            <div class="flex items-center gap-3 mb-6 text-kaizen-accent font-bold text-xl">
                <i class="fa-solid fa-helmet-safety"></i> SSOMA KAIZEN
            </div>
            <button onclick="createNewChat()" class="w-full bg-kaizen-red hover:bg-red-700 text-white py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors shadow-lg">
                <i class="fa-solid fa-plus"></i> Nuevo Chat
            </button>
        </div>

        <!-- Lista de Chats -->
        <div class="flex-1 overflow-y-auto p-2 space-y-1" id="chat-history-list">
            <!-- Los chats se renderizan aquí con JS -->
        </div>

        <!-- Footer Sidebar -->
        <div class="p-4 border-t border-gray-700 text-xs text-gray-500 text-center">
            v2.0 - Powered by Gemini
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full relative">
        
        <!-- Header Móvil -->
        <header class="md:hidden bg-kaizen-surface p-4 flex items-center justify-between border-b border-gray-800">
            <button onclick="toggleSidebar()" class="text-white"><i class="fa-solid fa-bars text-xl"></i></button>
            <span class="font-bold text-kaizen-accent">SSOMA KAIZEN</span>
            <div class="w-6"></div>
        </header>

        <!-- Área de Mensajes -->
        <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-6 scroll-smooth pb-32">
            
            <!-- Mensaje de Bienvenida (Default) -->
            <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center opacity-50">
                <div class="w-24 h-24 bg-gray-800 rounded-full flex items-center justify-center mb-4">
                    <i class="fa-solid fa-robot text-4xl text-kaizen-red"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">¿En qué puedo ayudarte hoy?</h2>
                <p class="max-w-md">Analizo riesgos, consulto el manual de Kaizen y reviso normativas de seguridad.</p>
            </div>

        </div>

        <!-- Área de Input (Fija abajo) -->
        <div class="absolute bottom-0 w-full bg-kaizen-dark p-4 border-t border-gray-800">
            <div class="max-w-4xl mx-auto">
                
                <!-- Previsualización de archivos -->
                <div id="file-preview" class="flex gap-2 mb-2 overflow-x-auto hidden"></div>

                <!-- Formulario -->
                <form id="chat-form" onsubmit="handleFormSubmit(event)" class="relative">
                    
                    <!-- Botón Subir Archivo -->
                    <button type="button" onclick="document.getElementById('file-input').click()" class="absolute left-3 top-3 text-gray-400 hover:text-white transition-colors" title="Adjuntar archivo/imagen">
                        <i class="fa-solid fa-paperclip text-lg"></i>
                    </button>
                    <input type="file" id="file-input" multiple class="hidden" onchange="handleFileSelect(event)">

                    <!-- Input Texto -->
                    <textarea id="user-input" rows="1" class="w-full bg-kaizen-surface text-white rounded-xl pl-12 pr-12 py-3 focus:outline-none focus:ring-2 focus:ring-kaizen-red resize-none overflow-hidden" placeholder="Escribe una consulta o sube una foto..." oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>

                    <!-- Botón Enviar -->
                    <button type="submit" id="send-btn" class="absolute right-3 top-3 text-kaizen-red hover:text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fa-solid fa-paper-plane text-lg"></i>
                    </button>
                </form>
                <p class="text-center text-xs text-gray-600 mt-2">SSOMA-Kaizen puede cometer errores. Verifica la información importante.</p>
            </div>
        </div>
    </main>

    <!-- Overlay para móvil -->
    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-10 hidden md:hidden"></div>

    <!-- Modal de Renombrar -->
    <div id="rename-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 hidden z-50">
        <div class="bg-kaizen-surface p-6 rounded-lg w-96 border border-gray-700 shadow-2xl">
            <h3 class="text-lg font-bold mb-4">Renombrar Chat</h3>
            <input type="text" id="rename-input" class="w-full bg-kaizen-dark p-2 rounded text-white mb-4 border border-gray-600 focus:border-kaizen-red outline-none">
            <div class="flex justify-end gap-2">
                <button onclick="closeRenameModal()" class="px-4 py-2 text-gray-400 hover:text-white">Cancelar</button>
                <button onclick="confirmRename()" class="px-4 py-2 bg-kaizen-red rounded text-white">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const API_URL = 'http://localhost:3000/chat/query'; // Ajusta si tu puerto cambia
        let chats = JSON.parse(localStorage.getItem('kaizen_chats')) || [];
        let currentChatId = null;
        let selectedFiles = [];

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            if (chats.length > 0) {
                // Cargar el último chat o el primero
                loadChat(chats[0].id);
            } else {
                createNewChat();
            }
            renderChatList();
        });

        // --- GESTIÓN DE CHATS ---
        function createNewChat() {
            const newId = Date.now().toString();
            const newChat = {
                id: newId,
                title: 'Nueva Conversación',
                messages: [],
                timestamp: Date.now()
            };
            chats.unshift(newChat); // Agregar al inicio
            saveChats();
            loadChat(newId);
            
            // En móvil, cerrar sidebar al crear
            if(window.innerWidth < 768) toggleSidebar();
        }

        function loadChat(id) {
            currentChatId = id;
            const chat = chats.find(c => c.id === id);
            
            // Renderizar mensajes
            const container = document.getElementById('messages-container');
            container.innerHTML = ''; // Limpiar

            if (chat.messages.length === 0) {
                document.getElementById('welcome-screen').classList.remove('hidden');
            } else {
                document.getElementById('welcome-screen').classList.add('hidden');
                chat.messages.forEach(msg => appendMessageToUI(msg.role, msg.content, msg.files));
            }
            
            renderChatList();
            scrollToBottom();
        }

        function deleteChat(id, event) {
            event.stopPropagation(); // Evitar abrir el chat al borrar
            if(!confirm('¿Estás seguro de eliminar este chat?')) return;
            
            chats = chats.filter(c => c.id !== id);
            saveChats();
            
            if (chats.length === 0) {
                createNewChat();
            } else if (currentChatId === id) {
                loadChat(chats[0].id);
            } else {
                renderChatList();
            }
        }

        // --- INTERFAZ DE LISTA DE CHATS ---
        function renderChatList() {
            const list = document.getElementById('chat-history-list');
            list.innerHTML = '';

            chats.forEach(chat => {
                const isActive = chat.id === currentChatId;
                const div = document.createElement('div');
                div.className = `group flex items-center justify-between p-3 rounded-lg cursor-pointer transition-colors ${isActive ? 'bg-gray-800 border border-gray-700' : 'hover:bg-gray-800/50 text-gray-400'}`;
                div.onclick = () => loadChat(chat.id);
                
                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <i class="fa-regular fa-message ${isActive ? 'text-kaizen-red' : ''}"></i>
                        <span class="truncate text-sm font-medium">${chat.title}</span>
                    </div>
                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="openRenameModal('${chat.id}', event)" class="text-xs hover:text-white"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteChat('${chat.id}', event)" class="text-xs hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // --- RENOMBRAR ---
        let chatToRename = null;
        function openRenameModal(id, event) {
            event.stopPropagation();
            chatToRename = id;
            const chat = chats.find(c => c.id === id);
            document.getElementById('rename-input').value = chat.title;
            document.getElementById('rename-modal').classList.remove('hidden');
        }
        function closeRenameModal() {
            document.getElementById('rename-modal').classList.add('hidden');
            chatToRename = null;
        }
        function confirmRename() {
            const newTitle = document.getElementById('rename-input').value.trim();
            if (newTitle && chatToRename) {
                const chat = chats.find(c => c.id === chatToRename);
                chat.title = newTitle;
                saveChats();
                renderChatList();
            }
            closeRenameModal();
        }

        // --- ENVÍO DE MENSAJES ---
        async function handleFormSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('user-input');
            const text = input.value.trim();

            if (!text && selectedFiles.length === 0) return;

            // 1. Agregar mensaje del usuario a la UI y Estado
            const userFilesPreview = selectedFiles.map(f => f.name); // Guardar nombres para referencia
            appendMessageToUI('user', text, selectedFiles);
            saveMessageToState('user', text, userFilesPreview);

            // 2. Limpiar input
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('welcome-screen').classList.add('hidden');
            
            // 3. Preparar datos para API
            const formData = new FormData();
            formData.append('text', text);
            selectedFiles.forEach(file => formData.append('files', file));
            
            // Limpiar archivos seleccionados en UI
            selectedFiles = [];
            renderFilePreview();

            // 4. Mostrar indicador de carga
            const loadingId = showLoading();

            try {
                // 5. Llamada al Backend
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Error en el servidor');
                const data = await response.json();

                // 6. Mostrar respuesta
                removeLoading(loadingId);
                appendMessageToUI('ai', data.reply);
                saveMessageToState('ai', data.reply);

                // Auto-renombrar si es el primer mensaje
                const currentChat = chats.find(c => c.id === currentChatId);
                if (currentChat.messages.length <= 2) {
                    const newTitle = text.substring(0, 25) + (text.length > 25 ? '...' : '');
                    currentChat.title = newTitle;
                    saveChats();
                    renderChatList();
                }

            } catch (error) {
                removeLoading(loadingId);
                appendMessageToUI('system', '❌ Error: No se pudo conectar con el servidor. Verifica que la API esté corriendo.');
            }
        }

        // --- UI HELPERS ---
        function appendMessageToUI(role, text, files = []) {
            const container = document.getElementById('messages-container');
            const div = document.createElement('div');
            const isUser = role === 'user';
            const isSystem = role === 'system';

            let fileHtml = '';
            if (files && files.length > 0) {
                // Si son objetos File (nuevos) o strings (historial)
                const fileCount = files.length;
                fileHtml = `<div class="mb-2 text-xs opacity-70 flex items-center gap-2"><i class="fa-solid fa-paperclip"></i> ${fileCount} archivo(s) adjunto(s)</div>`;
            }

            if (isSystem) {
                div.className = "flex justify-center my-4";
                div.innerHTML = `<div class="bg-red-900/50 text-red-200 text-sm px-4 py-2 rounded-full border border-red-800">${text}</div>`;
            } else {
                div.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
                
                // Icono del avatar
                const avatar = isUser 
                    ? `<div class="w-8 h-8 rounded bg-gray-700 flex items-center justify-center ml-3 flex-shrink-0"><i class="fa-solid fa-user text-sm"></i></div>`
                    : `<div class="w-8 h-8 rounded bg-kaizen-red flex items-center justify-center mr-3 flex-shrink-0"><i class="fa-solid fa-robot text-sm text-white"></i></div>`;

                // Contenido del mensaje
                const contentHtml = isUser 
                    ? `<div class="whitespace-pre-wrap">${text}</div>` 
                    : `<div class="markdown-body text-sm">${marked.parse(text)}</div>`;

                const bubbleClass = isUser 
                    ? 'bg-gray-700 text-white rounded-2xl rounded-tr-sm' 
                    : 'bg-transparent text-gray-100 w-full max-w-3xl pt-1'; // AI message no tiene fondo burbuja, estilo chatGPT

                div.innerHTML = `
                    ${!isUser ? avatar : ''}
                    <div class="max-w-[80%] ${bubbleClass} px-4 py-2">
                        ${fileHtml}
                        ${contentHtml}
                    </div>
                    ${isUser ? avatar : ''}
                `;
            }

            container.appendChild(div);
            scrollToBottom();
        }

        function showLoading() {
            const container = document.getElementById('messages-container');
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'flex justify-start';
            div.innerHTML = `
                <div class="w-8 h-8 rounded bg-kaizen-red flex items-center justify-center mr-3 flex-shrink-0">
                    <i class="fa-solid fa-robot text-sm text-white"></i>
                </div>
                <div class="bg-transparent px-4 py-3">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            container.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // --- MANEJO DE ARCHIVOS ---
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            selectedFiles = [...selectedFiles, ...files];
            renderFilePreview();
            // Limpiar input para permitir seleccionar el mismo archivo
            event.target.value = ''; 
        }

        function renderFilePreview() {
            const container = document.getElementById('file-preview');
            container.innerHTML = '';
            
            if (selectedFiles.length > 0) {
                container.classList.remove('hidden');
                selectedFiles.forEach((file, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2 bg-gray-800 px-3 py-1 rounded-full text-xs border border-gray-700 min-w-max';
                    
                    let icon = 'fa-file';
                    if(file.type.includes('image')) icon = 'fa-image';
                    if(file.type.includes('pdf')) icon = 'fa-file-pdf';
                    if(file.type.includes('sheet') || file.type.includes('excel') || file.type.includes('csv')) icon = 'fa-file-excel';

                    div.innerHTML = `
                        <i class="fa-solid ${icon} text-gray-400"></i>
                        <span class="max-w-[100px] truncate">${file.name}</span>
                        <button onclick="removeFile(${index})" class="text-gray-500 hover:text-red-400 ml-1"><i class="fa-solid fa-times"></i></button>
                    `;
                    container.appendChild(div);
                });
            } else {
                container.classList.add('hidden');
            }
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            renderFilePreview();
        }

        // --- UTILIDADES ---
        function saveChats() {
            localStorage.setItem('kaizen_chats', JSON.stringify(chats));
        }

        function saveMessageToState(role, content, files = []) {
            const chat = chats.find(c => c.id === currentChatId);
            if (chat) {
                chat.messages.push({ role, content, files, timestamp: Date.now() });
                saveChats();
            }
        }

        function scrollToBottom() {
            const container = document.getElementById('messages-container');
            container.scrollTop = container.scrollHeight;
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
            // Limitar altura máxima
            if(textarea.scrollHeight > 150) textarea.style.overflowY = "scroll";
            else textarea.style.overflowY = "hidden";
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('chat-form').dispatchEvent(new Event('submit'));
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }
    </script>
</body>
</html>